name: CI/CD Pipeline (Ultra Cache)

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: '⚠️ 跳过测试（仅紧急修复使用）'
        required: true
        default: false
        type: boolean
      skip_security_scan:
        description: '⚠️ 跳过安全扫描（仅紧急修复使用）'
        required: true
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  security-events: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/imitatort-stateless-agent
  RUST_MSRV: '1.85'
  SCCACHE_GHA_ENABLED: 'true'
  RUSTC_WRAPPER: 'sccache'

jobs:
  # ========== 阶段 1: 变更检测 ==========
  changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'src/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'examples/**'
            docker:
              - 'deploy/agent/Dockerfile'
              - 'docker-compose.yml'
              - '.github/workflows/ci-cd*.yml'

  # ========== 阶段 2: 缓存构建器（核心优化）==========
  # 策略：单 job 串行执行所有编译任务，建立完整缓存，避免多 job 缓存冲突
  # 所有产物保存为 artifact，供后续 job 直接下载使用
  cache-builder:
    name: Cache Builder
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      cache-hit: ${{ steps.cache-check.outputs.hit }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          targets: x86_64-unknown-linux-musl
          components: clippy

      # musl 工具链缓存
      - name: Cache musl tools
        uses: actions/cache@v4
        id: musl-cache
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-musl-${{ hashFiles('.github/workflows/ci-cd*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-musl-

      - name: Install musl tools
        if: steps.musl-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev
          # 配置链接器
          mkdir -p ~/.cargo
          echo '[target.x86_64-unknown-linux-musl]' >> ~/.cargo/config.toml
          echo 'linker = "musl-gcc"' >> ~/.cargo/config.toml

      - name: Install musl tools (from cache)
        if: steps.musl-cache.outputs.cache-hit == 'true'
        run: |
          sudo apt-get install -y musl-tools musl-dev
          # 配置链接器
          mkdir -p ~/.cargo
          echo '[target.x86_64-unknown-linux-musl]' >> ~/.cargo/config.toml
          echo 'linker = "musl-gcc"' >> ~/.cargo/config.toml

      # 检查缓存是否命中（用于后续优化）
      - name: Check cache status
        id: cache-check
        run: |
          # 检查 target 目录是否存在且非空
          if [ -d "target/x86_64-unknown-linux-musl/release" ] && [ "$(ls -A target/x86_64-unknown-linux-musl/release 2>/dev/null)" ]; then
            echo "hit=true" >> $GITHUB_OUTPUT
            echo "✅ 缓存命中，跳过依赖编译"
          else
            echo "hit=false" >> $GITHUB_OUTPUT
            echo "⏳ 缓存未命中，开始编译"
          fi

      # 统一的 Rust 缓存
      - uses: Swatinem/rust-cache@v2
        with:
          key: x86_64-musl-all
          shared-key: "ci-cache-musl-all"
          cache-on-failure: true
          cache-directories: |
            target/x86_64-unknown-linux-musl/release
            target/x86_64-unknown-linux-musl/release/examples

      - uses: mozilla-actions/sccache-action@v0.0.9

      # ========== 并行编译优化配置 ==========
      - name: Configure cargo for maximum parallelism
        run: |
          # 使用所有可用 CPU 核心
          echo "CARGO_BUILD_JOBS=$(nproc)" >> $GITHUB_ENV
          # 启用更激进的并行编译
          echo "CARGO_TARGET_JOBS=$(nproc)" >> $GITHUB_ENV
          # 显示配置
          echo "Using $(nproc) CPU cores for compilation"

      # ========== 串行执行（但每个命令内部高度并行）==========
      # 注意：不同 cargo 命令不能并行，会竞争 target/ 目录
      # 但每个命令内部使用所有 CPU 核心

      - name: 1. Clippy check (high parallelism)
        run: cargo clippy --target x86_64-unknown-linux-musl --all-features -- -D warnings
        env:
          RUSTFLAGS: "-C codegen-units=16"  # 更多 codegen units = 更多并行

      - name: 2. Test (default) - parallel
        run: cargo test --release --target x86_64-unknown-linux-musl
        env:
          RUSTFLAGS: "-C codegen-units=16"

      - name: 3. Test (persistent-store) - parallel
        run: cargo test --release --target x86_64-unknown-linux-musl --features persistent-store
        env:
          RUSTFLAGS: "-C codegen-units=16"

      - name: 4. Build release binaries - parallel
        run: |
          cargo build --release --target x86_64-unknown-linux-musl --bin imitatort --example werewolf
          mkdir -p dist
          cp target/x86_64-unknown-linux-musl/release/imitatort dist/
          cp target/x86_64-unknown-linux-musl/release/examples/werewolf dist/
          ls -la dist/
        env:
          RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=lld"  # 使用 lld 加速链接

      # 上传所有编译产物
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            target/x86_64-unknown-linux-musl/release/imitatort
            target/x86_64-unknown-linux-musl/release/examples/werewolf
          retention-days: 1

  # ========== 阶段 3: 非阻塞检查（并行执行）==========

  # 3a. Format Check - 不阻塞，快速完成
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    needs: changes
    continue-on-error: true
    if: needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          components: rustfmt
      - run: cargo fmt --check
      - name: Report format issues
        if: failure()
        run: |
          echo "⚠️ **代码格式检查未通过**" >> $GITHUB_STEP_SUMMARY
          echo "请运行以下命令修复：" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'cargo fmt' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # 3b. Docker 极速构建（依赖 cache-builder 的产物）
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [changes, cache-builder]
    if: |
      (needs.changes.outputs.rust == 'true' || needs.changes.outputs.docker == 'true' || github.event_name == 'workflow_dispatch') &&
      (github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4

      # 直接下载预编译的二进制，无需重新编译
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Verify artifacts
        run: |
          ls -la dist/
          file dist/imitatort
          file dist/werewolf

      - uses: docker/setup-buildx-action@v3

      - name: Build image (instant mode)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/agent/Dockerfile.instant
          push: false
          platforms: linux/amd64
          tags: ${{ env.IMAGE_NAME }}:latest
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
          outputs: type=docker,dest=/tmp/image.tar
          provenance: false

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.sha }}
          path: /tmp/image.tar
          retention-days: 1

  # 3c. Security Scan（依赖 docker-build 的镜像）
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [changes, docker-build]
    if: |
      (needs.changes.outputs.rust == 'true' || needs.changes.outputs.docker == 'true' || github.event_name == 'workflow_dispatch') &&
      !inputs.skip_security_scan &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ github.sha }}
          path: /tmp

      - name: Load image
        run: |
          docker load -i /tmp/image.tar
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ========== 阶段 4: 推送镜像（所有检查通过后）==========
  push:
    name: Push Image
    runs-on: ubuntu-latest
    needs: [changes, cache-builder, fmt, docker-build, security-scan]
    if: |
      always() &&
      (needs.cache-builder.result == 'success' || needs.cache-builder.result == 'skipped') &&
      (needs.docker-build.result == 'success' || needs.docker-build.result == 'skipped') &&
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped' || inputs.skip_security_scan) &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-,suffix=,enable=${{ github.ref_type != 'tag' }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=dev,enable=${{ github.ref_name == 'dev' }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/agent/Dockerfile.instant
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

  # ========== 质量门禁汇总报告 ==========
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [changes, cache-builder, fmt, docker-build, security-scan, push]
    if: always()
    steps:
      - name: Report Status
        run: |
          echo "## 质量门禁报告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 编译与构建" >> $GITHUB_STEP_SUMMARY
          echo "| 检查项 | 状态 | 说明 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Builder | ${{ needs.cache-builder.result }} | 编译、测试、构建一次完成 |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} | 极速构建（复用产物） |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 代码质量" >> $GITHUB_STEP_SUMMARY
          echo "| 检查项 | 状态 | 阻断发布 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.fmt.result }} | ❌ 否 |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} | ✅ 是（可跳过） |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 发布" >> $GITHUB_STEP_SUMMARY
          echo "| 检查项 | 状态 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Push Image | ${{ needs.push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=false
          if [[ "${{ needs.cache-builder.result }}" == "failure" ]]; then
            echo "❌ 编译/测试/构建失败" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          if [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "❌ Docker 构建失败" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          if [[ "${{ needs.security-scan.result }}" == "failure" && "${{ inputs.skip_security_scan }}" != "true" ]]; then
            echo "❌ 安全扫描发现漏洞" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          if [[ "$FAILED" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ❌ 质量门禁未通过，发布被阻断" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## ✅ 质量门禁通过" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.fmt.result }}" == "failure" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ 提示：代码格式检查未通过，建议运行 \`cargo fmt\` 修复" >> $GITHUB_STEP_SUMMARY
            fi
          fi
