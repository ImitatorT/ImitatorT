name: CI/CD Pipeline (Max Parallel)

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'âš ï¸ è·³è¿‡æµ‹è¯•ï¼ˆä»…ç´§æ€¥ä¿®å¤ä½¿ç”¨ï¼‰'
        required: true
        default: false
        type: boolean
      skip_security_scan:
        description: 'âš ï¸ è·³è¿‡å®‰å…¨æ‰«æï¼ˆä»…ç´§æ€¥ä¿®å¤ä½¿ç”¨ï¼‰'
        required: true
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  security-events: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/imitatort-stateless-agent
  RUST_MSRV: '1.85'
  # SCCache é…ç½® - æ‰€æœ‰ job å…±äº«
  SCCACHE_GHA_ENABLED: 'true'
  RUSTC_WRAPPER: 'sccache'
  SCCACHE_CACHE_SIZE: '2G'
  # Cargo å¹¶è¡Œé…ç½®
  CARGO_BUILD_JOBS: '8'
  CARGO_TARGET_JOBS: '8'
  CARGO_NET_RETRY: '10'
  RUSTFLAGS: '-C codegen-units=16'

jobs:
  # =============================================================================
  # é˜¶æ®µ 1: å˜æ›´æ£€æµ‹ (Change Detection)
  # =============================================================================
  job-detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust-code-changed: ${{ steps.filter.outputs.rust }}
      docker-config-changed: ${{ steps.filter.outputs.docker }}
      ci-config-changed: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filter changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'src/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'examples/**'
              - 'tests/**'
            docker:
              - 'deploy/agent/Dockerfile*'
              - 'docker-compose.yml'
            ci:
              - '.github/workflows/ci-cd*.yml'

  # =============================================================================
  # é˜¶æ®µ 2: å·¥å…·é“¾å‡†å¤‡ (Toolchain Setup)
  # =============================================================================
  job-setup-toolchain:
    name: âš™ï¸ Setup Toolchain
    runs-on: ubuntu-latest
    needs: job-detect-changes
    if: |
      needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
      needs.job-detect-changes.outputs.docker-config-changed == 'true' ||
      github.event_name == 'workflow_dispatch'
    outputs:
      musl-cache-hit: ${{ steps.musl-cache.outputs.cache-hit }}
    steps:
      - name: Cache musl toolchain
        id: musl-cache
        uses: actions/cache@v4
        with:
          path: |
            /usr/bin/x86_64-linux-musl-*
            /usr/bin/musl-*
            /usr/lib/x86_64-linux-musl
            /usr/include/x86_64-linux-musl
          key: ${{ runner.os }}-musl-toolchain-v1
          restore-keys: |
            ${{ runner.os }}-musl-toolchain-

      - name: Install musl toolchain
        if: steps.musl-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev binutils lld

      - name: Verify musl installation
        run: |
          x86_64-linux-musl-gcc --version
          musl-gcc --version || true

      - name: Configure Cargo for musl
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "rust-lld"
          rustflags = ["-C", "target-feature=+crt-static"]
          
          [profile.release]
          lto = true
          strip = true
          codegen-units = 16
          panic = "abort"
          EOF
          cat ~/.cargo/config.toml

  # =============================================================================
  # é˜¶æ®µ 3: ä»£ç è´¨é‡æ£€æŸ¥ (Code Quality) - å¹¶è¡Œæ‰§è¡Œ
  # =============================================================================
  
  # ---------------------------------------------------------------------------
  # 3.1: æ ¼å¼æ£€æŸ¥ (Format Check)
  # ---------------------------------------------------------------------------
  job-check-format:
    name: ðŸŽ¨ Check Format
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-setup-toolchain]
    continue-on-error: true
    if: |
      needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          components: rustfmt

      - name: Run cargo fmt
        run: cargo fmt --check

      - name: Report format issues
        if: failure()
        run: |
          echo "âš ï¸ **ä»£ç æ ¼å¼æ£€æŸ¥æœªé€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '\`\`\`bash' >> $GITHUB_STEP_SUMMARY
          echo 'cargo fmt' >> $GITHUB_STEP_SUMMARY
          echo '\`\`\`' >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # 3.2: Clippy é™æ€åˆ†æž (Clippy Lint)
  # ---------------------------------------------------------------------------
  job-check-clippy:
    name: ðŸ”Ž Clippy Analysis
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-setup-toolchain]
    if: |
      needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          targets: x86_64-unknown-linux-musl
          components: clippy

      - name: Restore musl toolchain
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/bin/x86_64-linux-musl-*
            /usr/bin/musl-*
            /usr/lib/x86_64-linux-musl
            /usr/include/x86_64-linux-musl
          key: ${{ runner.os }}-musl-toolchain-v1
          fail-on-cache-miss: true

      - name: Configure Cargo
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "rust-lld"
          rustflags = ["-C", "target-feature=+crt-static"]
          EOF

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: x86_64-musl-clippy
          shared-key: "x86_64-musl-shared"
          cache-on-failure: true

      - name: Setup SCCache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Run clippy
        run: |
          cargo clippy --target x86_64-unknown-linux-musl --all-features -- -D warnings
          echo "=== SCCache Stats ==="
          sccache --show-stats

  # =============================================================================
  # é˜¶æ®µ 4: æµ‹è¯•çŸ©é˜µ (Test Matrix) - å¹¶è¡Œæ‰§è¡Œ
  # =============================================================================
  
  # ---------------------------------------------------------------------------
  # 4.1: é»˜è®¤ç‰¹æ€§æµ‹è¯• (Test Default Features)
  # ---------------------------------------------------------------------------
  job-test-default:
    name: ðŸ§ª Test (Default)
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-setup-toolchain]
    if: |
      (needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      !inputs.skip_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          targets: x86_64-unknown-linux-musl

      - name: Restore musl toolchain
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/bin/x86_64-linux-musl-*
            /usr/bin/musl-*
            /usr/lib/x86_64-linux-musl
            /usr/include/x86_64-linux-musl
          key: ${{ runner.os }}-musl-toolchain-v1
          fail-on-cache-miss: true

      - name: Configure Cargo
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "rust-lld"
          rustflags = ["-C", "target-feature=+crt-static"]
          EOF

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: x86_64-musl-test-default
          shared-key: "x86_64-musl-shared"
          cache-on-failure: true

      - name: Setup SCCache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Run tests
        run: |
          cargo test --release --target x86_64-unknown-linux-musl
          echo "=== SCCache Stats ==="
          sccache --show-stats

  # ---------------------------------------------------------------------------
  # 4.2: æŒä¹…åŒ–å­˜å‚¨ç‰¹æ€§æµ‹è¯• (Test Persistent Store)
  # ---------------------------------------------------------------------------
  job-test-persistent:
    name: ðŸ§ª Test (Persistent Store)
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-setup-toolchain]
    if: |
      (needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      !inputs.skip_tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          targets: x86_64-unknown-linux-musl

      - name: Restore musl toolchain
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/bin/x86_64-linux-musl-*
            /usr/bin/musl-*
            /usr/lib/x86_64-linux-musl
            /usr/include/x86_64-linux-musl
          key: ${{ runner.os }}-musl-toolchain-v1
          fail-on-cache-miss: true

      - name: Configure Cargo
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "rust-lld"
          rustflags = ["-C", "target-feature=+crt-static"]
          EOF

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: x86_64-musl-test-persistent
          shared-key: "x86_64-musl-shared"
          cache-on-failure: true

      - name: Setup SCCache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Run tests with persistent-store feature
        run: |
          cargo test --release --target x86_64-unknown-linux-musl --features persistent-store
          echo "=== SCCache Stats ==="
          sccache --show-stats

  # =============================================================================
  # é˜¶æ®µ 5: æž„å»ºäº§ç‰© (Build Artifacts)
  # =============================================================================
  job-build-binaries:
    name: ðŸ”¨ Build Binaries
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-setup-toolchain]
    if: |
      needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
      needs.job-detect-changes.outputs.docker-config-changed == 'true' ||
      github.event_name == 'workflow_dispatch'
    outputs:
      build-cache-hit: ${{ steps.cache-check.outputs.hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_MSRV }}
          targets: x86_64-unknown-linux-musl

      - name: Restore musl toolchain
        uses: actions/cache/restore@v4
        with:
          path: |
            /usr/bin/x86_64-linux-musl-*
            /usr/bin/musl-*
            /usr/lib/x86_64-linux-musl
            /usr/include/x86_64-linux-musl
          key: ${{ runner.os }}-musl-toolchain-v1
          fail-on-cache-miss: true

      - name: Configure Cargo
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "rust-lld"
          rustflags = ["-C", "target-feature=+crt-static"]
          EOF

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: x86_64-musl-build
          shared-key: "x86_64-musl-shared"
          cache-on-failure: true
          cache-directories: |
            ~/.cargo/registry
            ~/.cargo/git
            target/x86_64-unknown-linux-musl/release

      - name: Setup SCCache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Check cache status
        id: cache-check
        run: |
          if [ -d "target/x86_64-unknown-linux-musl/release" ] && \
             [ -f "target/x86_64-unknown-linux-musl/release/imitatort" ] && \
             [ -f "target/x86_64-unknown-linux-musl/release/examples/werewolf" ]; then
            echo "hit=true" >> $GITHUB_OUTPUT
            echo "âœ… ç¼“å­˜å‘½ä¸­"
          else
            echo "hit=false" >> $GITHUB_OUTPUT
            echo "â³ éœ€è¦æž„å»º"
          fi

      - name: Build release binaries
        run: |
          cargo build --release --target x86_64-unknown-linux-musl --bin imitatort --example werewolf
          mkdir -p dist
          cp target/x86_64-unknown-linux-musl/release/imitatort dist/
          cp target/x86_64-unknown-linux-musl/release/examples/werewolf dist/
          ls -la dist/
          echo "=== SCCache Stats ==="
          sccache --show-stats

      - name: Verify binaries
        run: |
          file dist/imitatort
          file dist/werewolf
          ls -lh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            target/x86_64-unknown-linux-musl/release/imitatort
            target/x86_64-unknown-linux-musl/release/examples/werewolf
          retention-days: 1
          if-no-files-found: error

  # =============================================================================
  # é˜¶æ®µ 6: Docker æž„å»º (Docker Build)
  # =============================================================================
  job-build-docker:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-build-binaries]
    if: |
      (needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
       needs.job-detect-changes.outputs.docker-config-changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      (github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: .

      - name: Verify artifacts
        run: |
          ls -la dist/
          file dist/imitatort
          file dist/werewolf

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/agent/Dockerfile.instant
          push: false
          platforms: linux/amd64
          tags: ${{ env.IMAGE_NAME }}:latest
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.event.pull_request.head.repo.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
          outputs: type=docker,dest=/tmp/image.tar
          provenance: false
          cache-from: type=gha,scope=docker-build
          cache-to: type=gha,mode=max,scope=docker-build

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.sha }}
          path: /tmp/image.tar
          retention-days: 1
          if-no-files-found: error

  # =============================================================================
  # é˜¶æ®µ 7: å®‰å…¨æ‰«æ (Security Scan)
  # =============================================================================
  job-scan-security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [job-detect-changes, job-build-docker]
    if: |
      (needs.job-detect-changes.outputs.rust-code-changed == 'true' ||
       needs.job-detect-changes.outputs.docker-config-changed == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      !inputs.skip_security_scan &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ github.sha }}
          path: /tmp

      - name: Load Docker image
        run: |
          docker load -i /tmp/image.tar
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:scan
          docker images | grep imitatort

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # é˜¶æ®µ 8: æŽ¨é€é•œåƒ (Push Image)
  # =============================================================================
  job-push-image:
    name: ðŸ“¤ Push to Registry
    runs-on: ubuntu-latest
    needs:
      - job-detect-changes
      - job-check-format
      - job-check-clippy
      - job-test-default
      - job-test-persistent
      - job-build-binaries
      - job-build-docker
      - job-scan-security
    if: |
      always() &&
      (needs.job-check-clippy.result == 'success' || needs.job-check-clippy.result == 'skipped') &&
      (needs.job-test-default.result == 'success' || needs.job-test-default.result == 'skipped') &&
      (needs.job-test-persistent.result == 'success' || needs.job-test-persistent.result == 'skipped') &&
      (needs.job-build-binaries.result == 'success' || needs.job-build-binaries.result == 'skipped') &&
      (needs.job-build-docker.result == 'success' || needs.job-build-docker.result == 'skipped') &&
      (needs.job-scan-security.result == 'success' || needs.job-scan-security.result == 'skipped' || inputs.skip_security_scan) &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-,suffix=,enable=${{ github.ref_type != 'tag' }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=dev,enable=${{ github.ref_name == 'dev' }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: .

      - name: Verify artifacts before push
        run: |
          ls -la dist/
          file dist/imitatort

      - name: Build and push multi-platform image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/agent/Dockerfile.instant
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.event.pull_request.head.repo.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
          cache-from: type=gha,scope=docker-build
          provenance: false

  # =============================================================================
  # é˜¶æ®µ 9: è´¨é‡é—¨ç¦æ±‡æ€» (Quality Gate)
  # =============================================================================
  job-quality-gate:
    name: ðŸš¦ Quality Gate
    runs-on: ubuntu-latest
    needs:
      - job-detect-changes
      - job-check-format
      - job-check-clippy
      - job-test-default
      - job-test-persistent
      - job-build-binaries
      - job-build-docker
      - job-scan-security
      - job-push-image
    if: always()
    steps:
      - name: Generate quality report
        run: |
          echo "# ðŸš¦ è´¨é‡é—¨ç¦æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æµ‹å˜æ›´
          echo "## ðŸ“‹ å˜æ›´æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust ä»£ç  | ${{ needs.job-detect-changes.outputs.rust-code-changed == 'true' && 'âœ… å˜æ›´' || 'â­ï¸ æ— å˜æ›´' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker é…ç½® | ${{ needs.job-detect-changes.outputs.docker-config-changed == 'true' && 'âœ… å˜æ›´' || 'â­ï¸ æ— å˜æ›´' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç¼–è¯‘ä¸Žæž„å»º
          echo "## ðŸ”¨ ç¼–è¯‘ä¸Žæž„å»º" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çŠ¶æ€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Toolchain | ${{ needs.job-setup-toolchain.result }} | å·¥å…·é“¾å‡†å¤‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy Analysis | ${{ needs.job-check-clippy.result }} | é™æ€ä»£ç åˆ†æž |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Binaries | ${{ needs.job-build-binaries.result }} | äºŒè¿›åˆ¶æž„å»º |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.job-build-docker.result }} | é•œåƒæž„å»º |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä»£ç è´¨é‡
          echo "## ðŸŽ¨ ä»£ç è´¨é‡" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çŠ¶æ€ | é˜»æ–­å‘å¸ƒ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.job-check-format.result }} | âŒ å¦ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æµ‹è¯•
          echo "## ðŸ§ª æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çŠ¶æ€ | ç‰¹æ€§ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Default | ${{ needs.job-test-default.result }} | é»˜è®¤ç‰¹æ€§ |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Persistent | ${{ needs.job-test-persistent.result }} | persistent-store ç‰¹æ€§ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®‰å…¨
          echo "## ðŸ”’ å®‰å…¨" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çŠ¶æ€ | é˜»æ–­å‘å¸ƒ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.job-scan-security.result }} | ${{ inputs.skip_security_scan && 'â­ï¸ å·²è·³è¿‡' || 'âœ… æ˜¯' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å‘å¸ƒ
          echo "## ðŸ“¤ å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Push Image | ${{ needs.job-push-image.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Evaluate quality gate
        run: |
          FAILED=false
          
          if [[ "${{ needs.job-check-clippy.result }}" == "failure" ]]; then
            echo "âŒ Clippy æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.job-test-default.result }}" == "failure" ]]; then
            echo "âŒ é»˜è®¤ç‰¹æ€§æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.job-test-persistent.result }}" == "failure" ]]; then
            echo "âŒ æŒä¹…åŒ–å­˜å‚¨ç‰¹æ€§æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.job-build-binaries.result }}" == "failure" ]]; then
            echo "âŒ äºŒè¿›åˆ¶æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.job-build-docker.result }}" == "failure" ]]; then
            echo "âŒ Docker æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.job-scan-security.result }}" == "failure" && "${{ inputs.skip_security_scan }}" != "true" ]]; then
            echo "âŒ å®‰å…¨æ‰«æå‘çŽ°ä¸¥é‡æ¼æ´ž" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$FAILED" == "true" ]]; then
            echo "# âŒ è´¨é‡é—¨ç¦æœªé€šè¿‡ï¼Œå‘å¸ƒè¢«é˜»æ–­" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "# âœ… è´¨é‡é—¨ç¦é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.job-check-format.result }}" == "failure" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ æç¤ºï¼šä»£ç æ ¼å¼æ£€æŸ¥æœªé€šè¿‡ï¼Œå»ºè®®è¿è¡Œ \`cargo fmt\` ä¿®å¤" >> $GITHUB_STEP_SUMMARY
            fi
          fi
